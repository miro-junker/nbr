<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Phone Tilt Sensor</title>
</head>
<body>
  <h1>NoBrakes SmartPhone Joystick</h1>
  <button id="startBtn">Start Sending Tilt Data</button>
  <pre id="log"></pre>

  <script>
    const logEl = document.getElementById("log");
    const startBtn = document.getElementById("startBtn");

    function log(message) {
      logEl.textContent += message + "\n";
    }

    const ws = new WebSocket("wss://nobrakes.cz/?role=sensor");

    ws.onopen = () => log("âœ… Connected to WSS server");
    ws.onclose = () => log("âŒ Connection closed");
    ws.onerror = (err) => { log("âš ï¸ WebSocket error"); console.error(err); };
    ws.onmessage = (event) => log("ğŸ“© Message: " + event.data);

    function sendTilt(alpha, beta, gamma) {
      if(ws.readyState === WebSocket.OPEN){
        const data = { alpha, beta, gamma };
        ws.send(JSON.stringify(data));
        log("â¡ï¸ Sent tilt: " + JSON.stringify(data));
      }
    }

    function handleOrientation(event) {
      sendTilt(event.alpha, event.beta, event.gamma);
    }

    startBtn.addEventListener("click", () => {
      if (typeof DeviceOrientationEvent.requestPermission === "function") {
        DeviceOrientationEvent.requestPermission()
          .then(state => {
            if(state === "granted"){
              window.addEventListener("deviceorientation", handleOrientation);
              log("ğŸ“± Tilt sensor enabled");
            } else log("âš ï¸ Permission denied");
          })
          .catch(console.error);
      } else {
        window.addEventListener("deviceorientation", handleOrientation);
        log("ğŸ“± Tilt sensor enabled");
      }
      startBtn.disabled = true;
    });
  </script>
</body>
</html>
